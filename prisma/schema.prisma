generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Conversation {
  id               Int       @id @default(autoincrement())
  guest_id         Int?
  messages         Json
  last_interaction DateTime? @default(now()) @db.Timestamp(6)
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @db.Timestamp(6)
  guests           Guest?   @relation(fields: [guest_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "conversation_guest_id_guests_id_fk")

  @@map("conversations")
}

model Customer {
  id          Int            @id @default(autoincrement())
  user_id     Int            @unique(map: "customers_user_id_unique")
  theme       String         @default("classic") @db.VarChar(100)
  status      CustomerStatus @default(Active)
  note        String?        @db.VarChar(150)
  user        User           @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "customers_user_id_users_id_fk")
  invitations Invitation[]

  @@map("customers")
}

model Feature {
  id                  Int                   @id @default(autoincrement())
  name                String                @db.VarChar(100)
  description         String?               @db.VarChar(255)
  is_active           Boolean               @default(true)
  created_at          DateTime?             @default(now()) @db.Timestamp(6)
  updated_at          DateTime?             @default(now()) @db.Timestamp(6)
  invitation_features InvitationFeature[]

  @@map("features")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Guest {
  id            Int            @id @default(autoincrement())
  invitation_id Int
  phone         String         @db.VarChar(15)
  name          String         @db.VarChar(150)
  participant   Int            @default(1)
  status        GuestStatus
  note          String?        @db.VarChar(255)
  rsvp_at       DateTime?      @db.Timestamp(6)
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  updated_at    DateTime?      @default(now()) @db.Timestamp(6)
  conversation  Conversation[]
  invitations   Invitation    @relation(fields: [invitation_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "guests_invitation_id_invitations_id_fk")

  @@index([phone], map: "guest_phone_index")
  @@map("guests")
}

model InvitationFeature {
  invitation_id Int
  feature_id    Int
  is_enabled    Boolean?    @default(true)
  created_at    DateTime?   @default(now()) @db.Timestamp(6)
  updated_at    DateTime?   @default(now()) @db.Timestamp(6)
  features      Feature    @relation(fields: [feature_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "invitation_features_feature_id_features_id_fk")
  invitations   Invitation @relation(fields: [invitation_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "invitation_features_invitation_id_invitations_id_fk")

  @@id([invitation_id, feature_id], map: "invitation_features_invitation_id_feature_id_pk")
  @@map("invitation_features")
}

model Invitation {
  id                  Int                   @id @default(autoincrement())
  customer_id         Int
  name                String                @db.VarChar(150)
  theme               String                @db.VarChar(100)
  wedding_date        DateTime              @db.Date
  ai_context          String?
  created_at          DateTime?             @default(now()) @db.Timestamp(6)
  updated_at          DateTime?             @default(now()) @db.Timestamp(6)
  guests              Guest[]
  invitation_features InvitationFeature[]
  customer            Customer              @relation(fields: [customer_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "invitations_customer_id_customers_id_fk")
  @@map("invitations")
}

model Permission {
  id             Int              @id @default(autoincrement())
  key            String           @unique(map: "permissions_key_unique") @db.VarChar(100)
  name           String           @db.VarChar(100)
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "role_permissions_roleId_roles_id_fk")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "role_permissions_permissionId_permissions_id_fk")

  @@id([roleId, permissionId], map: "role_permissions_roleId_permissionId_pk")
  @@map("role_permissions")
}

model Role {
  id             Int              @id @default(autoincrement())
  name           String           @unique(map: "roles_name_unique") @db.VarChar(100)
  rolePermissions RolePermission[]
  userRoles      UserRole[]

  @@map("roles")
}

model UserRole {
  userId Int
  roleId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "user_roles_userId_users_id_fk")
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "user_roles_roleId_roles_id_fk")

  @@id([userId, roleId], map: "user_roles_userId_roleId_pk")
  @@map("user_roles")
}

/// This model contains an expserression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model User {
  id        Int        @id @default(autoincrement())
  name      String     @db.VarChar(255)
  password  String     @db.VarChar(255)
  email     String     @unique(map: "users_email_unique") @db.VarChar(255)
  phone     String     @unique(map: "users_phone_unique") @db.VarChar(15)
  customers Customer?
  userRoles UserRole[]

  @@map("users")
}

enum CustomerStatus {
  Active
  In_Active @map("In Active")
}

enum GuestStatus {
  Invited
  Attending
  NotAttending
  Declined
  Maybe
}

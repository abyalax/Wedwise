generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Permission {
  id              Int              @id @default(autoincrement())
  key             String           @unique(map: "permissions_key_unique") @db.VarChar(100)
  name            String           @db.VarChar(100)
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "role_permissions_roleId_roles_id_fk")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "role_permissions_permissionId_permissions_id_fk")

  @@id([roleId, permissionId], map: "role_permissions_roleId_permissionId_pk")
  @@map("role_permissions")
}

model Role {
  id              Int              @id @default(autoincrement())
  name            String           @unique(map: "roles_name_unique") @db.VarChar(100)
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@map("roles")
}

model UserRole {
  userId Int
  roleId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "user_roles_userId_users_id_fk")
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "user_roles_roleId_roles_id_fk")

  @@id([userId, roleId], map: "user_roles_userId_roleId_pk")
  @@map("user_roles")
}

model User {
  id        Int        @id @default(autoincrement())
  name      String     @db.VarChar(255)
  password  String     @db.VarChar(255)
  email     String     @unique(map: "users_email_unique") @db.VarChar(255)
  phone     String     @unique(map: "users_phone_unique") @db.VarChar(15)
  customers Customer?
  userRoles UserRole[]

  @@map("users")
}

model Agent {
  id           Int    @id @default(autoincrement())
  name         String
  systemPrompt String
  context      String
  provider     String
  model        String
  apiKey       String

  @@map("agents")
}

model Customer {
  id     Int @id @default(autoincrement())
  userId Int @unique

  note String?

  user   User             @relation(fields: [userId], references: [id])
  status StatusActivation @default(Active)
  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

model Feature {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?
  price       String

  status          StatusActivation
  packageFeatures PackageFeature[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  theme     Theme?   @relation(fields: [themeId], references: [id])
  themeId   Int?

  @@map("features")
}

model Package {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?
  price       String

  status   StatusActivation
  features PackageFeature[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("packages")
}

model PackageFeature {
  packageId Int
  featureId Int

  package Package @relation(fields: [packageId], references: [id])
  feature Feature @relation(fields: [featureId], references: [id])

  @@id([packageId, featureId])
  @@map("package_features")
}

model Guest {
  id           Int @id @default(autoincrement())
  invitationId Int

  name        String
  phone       String
  participant Int       @default(1)
  rsvpAt      DateTime?

  conversation Conversation?

  invitation Invitation @relation(fields: [invitationId], references: [id])

  @@index([phone])
  @@map("guests")
}

model Conversation {
  id      Int @id @default(autoincrement())
  guestId Int @unique

  messages Json

  guest Guest @relation(fields: [guestId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("conversations")
}

model Invitation {
  id      Int @id @default(autoincrement())
  orderId Int @unique

  aiContext String
  groomName String
  brideName String
  themeCode String
  contents  Json

  guests Guest[]
  order  Order   @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invitations")
}

model Theme {
  id    Int    @id @default(autoincrement())
  slug  String @unique
  name  String
  image String
  code  String

  categoryId Int
  status     StatusActivation

  category ThemeCategory @relation(fields: [categoryId], references: [id])
  features Feature[]
  orders   Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("themes")
}

model ThemeCategory {
  id   Int    @id @default(autoincrement())
  name String

  themes Theme[]

  @@map("theme_categories")
}

model Payment {
  id      Int @id @default(autoincrement())
  orderId Int

  provider PaymentProvider
  method   String
  amount   String

  status  PaymentStatus
  payload Json?

  order Order @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())

  @@map("payments")
}

model Order {
  id         Int  @id @default(autoincrement())
  customerId Int?

  status     OrderStatus
  totalPrice String

  themeSnapshot   Json
  packageSnapshot Json

  items      OrderItem[]
  invitation Invitation?
  payments   Payment[]

  customer Customer? @relation(fields: [customerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  theme     Theme?   @relation(fields: [themeId], references: [id])
  themeId   Int?

  @@map("orders")
}

model OrderItem {
  id      Int @id @default(autoincrement())
  orderId Int

  featureCode  String
  featureName  String
  featurePrice String

  order Order @relation(fields: [orderId], references: [id])

  @@map("order_items")
}

enum StatusActivation {
  Active
  InActive @map("In Active")
}

enum OrderStatus {
  Draft
  InProgress     @map("In Progress")
  WaitingPayment @map("Waiting Payment")
  Paid           @map("Paid")
  Cancelled      @map("Cancelled")
}

enum PaymentStatus {
  Pending
  Success
  Failed
  Expired
}

enum PaymentProvider {
  MIDTRANS
  XENDIT
  SHOPEE
}
